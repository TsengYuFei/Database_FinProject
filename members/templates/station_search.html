{% extends 'homepage.html' %}

{% block main %}
<div class="primary">
    <div class="left">
        <h3>書本查詢：</h3>
        <script>
            function sanitizeInput() {
                const fields = ['title_query', 'isbn_query', 'lname_query', 'fname_query', 'publisher_query'];
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    if (input) {
                        input.value = input.value.trim().replace(/\s+/g, ' '); // 去除多餘的空格
                    }
                });
            }

            function validateForm() {
                const checkboxes = [
                    document.getElementById('search_by_title'),
                    document.getElementById('search_by_isbn'),
                    document.getElementById('search_by_lname'),
                    document.getElementById('search_by_fname'),
                    document.getElementById('search_by_publisher')
                ];
                const inputs = [
                    document.getElementById('title_query'),
                    document.getElementById('isbn_query'),
                    document.getElementById('lname_query'),
                    document.getElementById('fname_query'),
                    document.getElementById('publisher_query')
                ];

                const anyChecked = checkboxes.some(checkbox => checkbox.checked);
                const anyInputProvided = inputs.some((input, index) => {
                    return checkboxes[index].checked && input.value.trim() !== '';
                });

                if (!anyChecked) {
                    alert('請勾選查詢種類');
                    return false;
                }

                if (anyChecked && !anyInputProvided) {
                    alert('請輸入查詢資訊');
                    return false;
                }

                sanitizeInput();
                return true;
            }
        </script>
        <form method="get" action="{% url 'book_search' %}" onsubmit="return validateForm()">
            <div>
                <input type="checkbox" id="search_by_title" name="search_by_title">
                <label for="search_by_title">書名</label>
                <input type="text" id="title_query" name="title_query"
                    value="{{ request.GET.title_query|default_if_none:'' }}">
            </div>
            <div>
                <input type="checkbox" id="search_by_isbn" name="search_by_isbn">
                <label for="search_by_isbn">ISBN</label>
                <input type="text" id="isbn_query" name="isbn_query"
                    value="{{ request.GET.isbn_query|default_if_none:'' }}">
            </div>
            <div>
                <input type="checkbox" id="search_by_lname" name="search_by_lname">
                <label for="search_by_lname">姓</label>
                <input type="text" id="lname_query" name="lname_query"
                    value="{{ request.GET.lname_query|default_if_none:'' }}">
            </div>
            <div>
                <input type="checkbox" id="search_by_fname" name="search_by_fname">
                <label for="search_by_fname">名</label>
                <input type="text" id="fname_query" name="fname_query"
                    value="{{ request.GET.fname_query|default_if_none:'' }}">
            </div>
            <div>
                <input type="checkbox" id="search_by_publisher" name="search_by_publisher">
                <label for="search_by_publisher">出版社</label>
                <input type="text" id="publisher_query" name="publisher_query"
                    value="{{ request.GET.publisher_query|default_if_none:'' }}">
            </div>
            <div class="search-box">
                <button type="submit">查詢</button>
            </div>
        </form>
        <br>
        <hr><br>
        <h3>站點查詢：</h3>
        <form method="get" action="{% url 'station_search' %}">
            <div class="search-box-station">
                <label for="station_location">查詢地點</label>
                <select id="station_location" name="station_location">
                    <option value="Taipei">臺北</option>
                    <option value="Taichung">臺中</option>
                </select>
                <button type="submit">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </form>
    </div>
    <div class="right">
        {% if stations %}
        <h3>站點搜索結果：</h3>
        <table class="station-table">
            <thead>
                <tr>
                    <th>站名</th>
                    <th>狀態</th>
                    <th>地址</th>
                </tr>
            </thead>
            <tbody>
                {% for station in stations %}
                <tr>
                    <td><a href="{% url 'station_detail' station.id %}">{{ station.name }}</a></td>
                    <td class="status-{{ station.statu }}">{{ station.get_statu_display }}</td>
                    <td>{{ station.addr }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>查無站點</p>
        {% endif %}
    </div>
</div>
{% endblock %}